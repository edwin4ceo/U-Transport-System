<?php
session_start();
include "db_connect.php";
include "function.php";

if(!isset($_SESSION['student_id'])){
    redirect("passanger_login.php");
}

$student_id = $_SESSION['student_id'];
$message = "";

// Handle Form Update
if(isset($_POST['update'])){
    $name  = $_POST['name'];
    $phone = $_POST['phone'];
    
    // Update Database
    $sql = "UPDATE students SET name=?, phone=? WHERE student_id=?";
    $stmt = $conn->prepare($sql);
    $stmt->bind_param("sss", $name, $phone, $student_id);
    
    if($stmt->execute()){
        // Update Session Name
        $_SESSION['student_name'] = $name;
        
        // Success Alert and Redirect back to Profile
        $_SESSION['swal_title'] = "Profile Updated";
        $_SESSION['swal_msg'] = "Your details have been saved.";
        $_SESSION['swal_type'] = "success";
        redirect("profile.php");
    } else {
        alert("Error updating profile.");
    }
}

// Fetch current data
$stmt = $conn->prepare("SELECT * FROM students WHERE student_id = ?");
$stmt->bind_param("s", $student_id);
$stmt->execute();
$row = $stmt->get_result()->fetch_assoc();

include "header.php"; 
?>

<h2>Edit Profile</h2>

<form action="" method="POST">
    <label>Full Name</label>
    <input type="text" name="name" value="<?php echo htmlspecialchars($row['name']); ?>" required>

    <label>Student ID (Cannot change)</label>
    <input type="text" value="<?php echo htmlspecialchars($row['student_id']); ?>" disabled style="background: #eee;">

    <label>Email (Cannot change)</label>
    <input type="email" value="<?php echo htmlspecialchars($row['email']); ?>" disabled style="background: #eee;">

    <label>Phone Number</label>
    <input type="text" name="phone" value="<?php echo htmlspecialchars($row['phone'] ?? ''); ?>" placeholder="Enter your phone number">

    <button type="submit" name="update">Save Changes</button>
</form>

<div style="margin-top: 15px;">
    <a href="passanger_profile.php" style="color: #666; text-decoration: none;">&larr; Back to Profile</a>
</div>

<?php include "footer.php"; ?>